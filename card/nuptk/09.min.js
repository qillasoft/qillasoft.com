(function(){
  const allowed = ['qillasoft.com', 'www.qillasoft.com'];
  if (!allowed.includes(location.hostname)) {
    location.href = 'https://www.qillasoft.com/p/nuptk.html';
    return;
  }
})();

// Fungsi untuk mengunduh PDF menggunakan jsPDF
async function downloadPDF() {
    // Tampilkan loading indicator
    loadingIndicator.style.display = 'block';
    
    try {
        // Buat PDF menggunakan jsPDF
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        
        // Tambahkan judul
        pdf.setFontSize(16);
        pdf.setFont('helvetica', 'bold');
        pdf.text('Kartu NUPTK', 105, 20, { align: 'center' });
        
        // Tambahkan kartu depan (kiri)
        await drawFrontCard(pdf, 16, 40);
        
        // Tambahkan kartu belakang (kanan)
        await drawBackCard(pdf, 109, 40);
        
        // Tambahkan footer
        pdf.setFontSize(12);
        pdf.setFont('helvetica');
        pdf.setTextColor(127, 140, 141);
        pdf.text('Dicetak di www.qillasoft.com', 105, 280, { align: 'center' });
        
        // Simpan PDF
        pdf.save(`kartu-nuptk-${nuptkInput.value}.pdf`);
        
    } catch (error) {
        console.error('Error generating PDF:', error);
        alert('Terjadi kesalahan saat membuat PDF. Silakan coba lagi.');
    } finally {
        // Sembunyikan loading indicator
        loadingIndicator.style.display = 'none';
    }
}

// Fungsi untuk menggambar kartu depan secara langsung di PDF
async function drawFrontCard(pdf, x, y) {
    const cardWidth = 86.4; // mm
    const cardHeight = 54; // mm
    
    // Gambar latar belakang kartu depan
    const frontBgImg = new Image();
    frontBgImg.src = 'https://cdn.qillasoft.com/card/nuptk/nuptk_front.jpg';
    
    await new Promise((resolve) => {
        frontBgImg.onload = () => {
            pdf.addImage(frontBgImg, 'JPEG', x, y, cardWidth, cardHeight);
            resolve();
        };
        frontBgImg.onerror = () => {
            // Jika gambar gagal dimuat, buat kotak kosong
            pdf.setDrawColor(0);
            pdf.setFillColor(255, 255, 255);
            pdf.rect(x, y, cardWidth, cardHeight, 'FD');
            resolve();
        };
    });
    
    // Tambahkan foto
    if (currentPhotoFile) {
        const reader = new FileReader();
        await new Promise((resolve) => {
            reader.onload = function(e) {
                const photoWidth = 19; // mm
                const photoHeight = 28.5; // mm
                pdf.addImage(e.target.result, 'JPEG', x + 3.9, y + cardHeight - photoHeight - 4.6, photoWidth, photoHeight);
                resolve();
            };
            reader.readAsDataURL(currentPhotoFile);
        });
    }
    
    // Tambahkan data teks - menggunakan Helvetica seperti di preview
    pdf.setTextColor(0, 0, 0);
    
    // Posisi data (disesuaikan dengan preview)
    const dataX = x + 26.5; // Posisi X untuk data
    const dataY = y + 27; // Posisi Y untuk data pertama
    const lineHeight = 4.6; // Jarak antar baris
    
    // Hitung ukuran font berdasarkan panjang teks (mirip dengan CSS)
    const nuptkValue = nuptkInput.value || '';
    const namaValue = nameInput.value || '';
    const tglValue = formatDate(birthDateInput.value) || '';
    const tlValue = birthPlaceInput.value || '';
    const jkValue = genderInput.value || '';

   // Judul NUPTK
    let jdlnuptkFontSize = 7.5;
    
    pdf.setFontSize(jdlnuptkFontSize);
    pdf.setFont('helvetica', 'bold');
    pdf.text('NUPTK', dataX, dataY);
    pdf.text(':', dataX + 18.4, dataY);
    
    // Judul Nama, Tempat Lahir, Tanggal Lahir, Jenis Kelamin
    let jdlFontSize = 7.5;
    
    pdf.setFontSize(jdlFontSize);
    pdf.setFont('helvetica', 'normal');
    pdf.text('Nama', dataX, dataY + lineHeight);
    pdf.text(':', dataX + 18.4, dataY + lineHeight);
    pdf.text('Tempat Lahir', dataX, dataY + lineHeight * 2);
    pdf.text(':', dataX + 18.4, dataY + lineHeight * 2);
    pdf.text('Tanggal Lahir', dataX, dataY + lineHeight * 3);
    pdf.text(':', dataX + 18.4, dataY + lineHeight * 3);
    pdf.text('Jenis Kelamin', dataX, dataY + lineHeight * 4);
    pdf.text(':', dataX + 18.4, dataY + lineHeight * 4);
    
    // Isi Data NUPTK
    let nuptkFontSize = 7.5;
    if (nuptkValue.length > 25) nuptkFontSize = 6.3;
    else if (nuptkValue.length > 22) nuptkFontSize = 7;
    
    pdf.setFontSize(nuptkFontSize);
    pdf.setFont('helvetica', 'bold');
    pdf.text(nuptkValue, dataX + 20.2, dataY);
    
    // Isi Data Nama
    let namaFontSize = 7.5;
    if (namaValue.length > 25) namaFontSize = 6.3;
    else if (namaValue.length > 22) namaFontSize = 7;
    
    pdf.setFontSize(namaFontSize);
    pdf.setFont('helvetica', 'normal');
    pdf.text(namaValue, dataX + 20.2, dataY + lineHeight);
    
    // Isi Data Tempat Lahir
    let tlFontSize = 7.5;
    if (tlValue.length > 25) tlFontSize = 6.3;
    else if (tlValue.length > 22) tlFontSize = 7;
    
    pdf.setFontSize(tlFontSize);
    pdf.setFont('helvetica', 'normal');
    pdf.text(tlValue, dataX + 20.2, dataY + lineHeight * 2);
    
    // Isi Data Tanggal Lahir
    let tglFontSize = 7.5;
    if (tglValue.length > 25) tglFontSize = 6.3;
    else if (tglValue.length > 22) tglFontSize = 7;
    
    pdf.setFontSize(tglFontSize);
    pdf.setFont('helvetica', 'normal');
    pdf.text(tglValue, dataX + 20.2, dataY + lineHeight * 3);
    
    // Isi Data Jenis Kelamin
    let jkFontSize = 7.5;
    if (jkValue.length > 25) jkFontSize = 6.3;
    else if (jkValue.length > 22) jkFontSize = 7;
    
    pdf.setFontSize(jkFontSize);
    pdf.setFont('helvetica', 'normal');
    pdf.text(jkValue, dataX + 20.2, dataY + lineHeight * 4);
    
    // Tambahkan QR Code
    if (nuptkInput.value && nameInput.value) {
        const qrCanvas = document.getElementById('canvas');
        const qrDataURL = qrCanvas.toDataURL('image/png');
        pdf.addImage(qrDataURL, 'PNG', x + cardWidth - 13, y + cardHeight - 13, 11, 11);
    }
}

// Fungsi untuk menggambar kartu belakang secara langsung di PDF
async function drawBackCard(pdf, x, y) {
    const cardWidth = 86.4; // mm
    const cardHeight = 54; // mm
    
    // Gambar latar belakang kartu belakang
    const backBgImg = new Image();
    backBgImg.src = 'https://cdn.qillasoft.com/card/nuptk/nuptk_back.jpg';
    
    await new Promise((resolve) => {
        backBgImg.onload = () => {
            pdf.addImage(backBgImg, 'JPEG', x, y, cardWidth, cardHeight);
            resolve();
        };
        backBgImg.onerror = () => {
            // Jika gambar gagal dimuat, buat kotak kosong
            pdf.setDrawColor(0);
            pdf.setFillColor(255, 255, 255);
            pdf.rect(x, y, cardWidth, cardHeight, 'FD');
            resolve();
        };
    });
}
