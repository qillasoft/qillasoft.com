<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <title>Crop Foto 4×6cm (Kartu NUPTK)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="cropper.min.css">
    <link rel="stylesheet" href="style.min.css">
</head>

<body>
    <div class="container">
        <h1>Crop Foto 4×6 cm untuk Kartu NUPTK</h1>
        <div class="card">
            <div class="size-info"><b>Ukuran Foto Kartu NUPTK:</b> 4×6 cm (472×708 pixel @ 300 DPI)</div>
            <form id="form" method="POST" enctype="multipart/form-data">
                <div class="previewWrap">
                    <div class="imgArea">
                        <img id="image" alt="Preview akan tampil di sini" />
                    </div>
                    <div class="side">
                        <div class="miniPreview">
                            <div class="tinyNote">Preview Crop</div>
                            <canvas id="mini" width="118" height="177"></canvas>
                        </div>
                        <br>
                        <div class="btnRow">
                            <button type="button" id="reset" class="btnGhost">Reset Crop</button>
                            <button type="button" id="process" class="btn">Proses & Simpan</button>
                        </div>
                    </div>
                </div>
                <!-- dataURL hasil crop dikirim ke server -->
                <input type="hidden" id="cropped_image" name="cropped_image">
            </form>
        </div>

        <div class="credit">
            © 2025 ‧ <a href="https://qillasoft.com" target="_blank">QILLASOFT</a> ‧ All rights reserved.
        </div>
    </div>

    <script src="cropper.min.js"></script>
    <script>
        const imgEl = document.getElementById('image');
        const form = document.getElementById('form');
        const hiddenInput = document.getElementById('cropped_image');
        const miniCanvas = document.getElementById('mini');
        const resetBtn = document.getElementById('reset');
        const processBtn = document.getElementById('process');
        let cropper = null;

        // Ambil data gambar dari localStorage
        function loadImageFromStorage() {
            const photoData = localStorage.getItem('nuptk_crop_photo');
            if (photoData) {
                imgEl.src = photoData;
                initializeCropper();
            } else {
                // Jika tidak ada data, tampilkan pesan dan tutup setelah 3 detik
                document.body.innerHTML = `
                    <div class="container">
                        <div class="card">
                            <div style="text-align: center; color: #E0E0E0; padding: 40px;">
                                <h2>Tidak ada foto untuk di-crop</h2>
                                <p>Silakan tutup jendela ini dan upload foto terlebih dahulu di halaman utama.</p>
                                <p>Jendela akan tertutup otomatis dalam 3 detik...</p>
                            </div>
                        </div>
                    </div>
                `;
                setTimeout(() => {
                    window.close();
                }, 3000);
            }
        }

        function initializeCropper() {
            if (cropper) cropper.destroy();
            cropper = new Cropper(imgEl, {
                aspectRatio: 4 / 6,    // kunci 4:6
                viewMode: 1,
                dragMode: 'move',
                autoCropArea: 0.8,
                background: false,
                responsive: true,
                crop() {
                    // Update mini preview realtime (diperkecil 25% untuk tampilan)
                    try {
                        const c = cropper.getCroppedCanvas({width: 472, height: 708});
                        const ctx = miniCanvas.getContext('2d');
                        ctx.clearRect(0,0,miniCanvas.width, miniCanvas.height);
                        
                        // Gambar dengan skala 25% untuk preview
                        ctx.drawImage(c, 0, 0, 118, 177);
                    } catch(_) {}
                }
            });
        }

        // Reset gambar
        resetBtn.addEventListener('click', (e) => {
            e.preventDefault();
            const photoData = localStorage.getItem('nuptk_crop_photo');
            if (photoData) {
                imgEl.src = photoData;
                const ctx = miniCanvas.getContext('2d');
                ctx.clearRect(0,0,miniCanvas.width, miniCanvas.height);
                if (cropper) { cropper.destroy(); cropper = null; }
                initializeCropper();
            }
        });

        // Saat proses, ambil hasil crop sebagai JPG (quality 0.95)
        processBtn.addEventListener('click', (e) => {
            if (!cropper) {
                alert('Silakan atur area crop terlebih dahulu.');
                return;
            }
            const canvas = cropper.getCroppedCanvas({ width: 472, height: 708 });
            if (!canvas) {
                alert('Gagal membuat hasil crop. Coba gambar lain.');
                return;
            }
            
            // Kompres gambar ke format JPG dengan kualitas 0.95
            const croppedDataURL = canvas.toDataURL('image/jpeg', 0.95);
            
            // Kirim data gambar kembali ke halaman utama
            if (window.opener && !window.opener.closed) {
                window.opener.postMessage({
                    type: 'CROPPED_PHOTO',
                    dataURL: croppedDataURL
                }, '*');
                
                // Bersihkan localStorage
                localStorage.removeItem('nuptk_crop_photo');
                
                // Tutup jendela crop
                window.close();
            } else {
                alert('Tidak dapat mengirim hasil crop. Silakan tutup jendela ini dan coba lagi.');
            }
        });

        // Muat gambar saat halaman siap
        document.addEventListener('DOMContentLoaded', loadImageFromStorage);

        // Bersihkan localStorage jika jendela ditutup tanpa proses
        window.addEventListener('beforeunload', function() {
            localStorage.removeItem('nuptk_crop_photo');
        });
    </script>
</body>
</html>
